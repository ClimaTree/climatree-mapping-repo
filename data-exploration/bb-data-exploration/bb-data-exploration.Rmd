---
title: "Exploring Raw Tree Data"
author: "Briana Barajas"
date: 2024-01-28
---

## Preparation

Set-up chunk

```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

Load libraries

```{r}
library(tidyverse)
library(here)

library(sf) # vector data
library(terra) #raster data
library(tmap) # mapping
```

## Find 20 Most Sampled Species

### Read Dendro Data

```{r}
## ==================================================
##                 read in data                  ----
## ==================================================
# read in tree ring data
rwi_long <- read_csv(here("~","..", "..", "capstone", "climatree", "dataverse-archive", "rwi_long.csv"))

# read in site summary table
site_smry <- read_table(here("~","..", "..", "capstone", "climatree", "dataverse-archive", "site_summary.tab"))

# read in species metadata
species_metadata <- read_csv(here("~","..", "..", "capstone", "climatree", "dataverse-archive", "species_metadata.csv"))

# essential cwd data (3b.R site-specific historic climate data)
site_clim <- read_csv(here("~","..", "..", "capstone", "climatree", "dataverse-archive", "essentialcwd_data.csv"))

```

### Filter Tree Species

```{r}
## ==================================================
##                 prep for join                ----
## ==================================================

# ...... update species metadata ......
species_metadata <- species_metadata %>% 
  rename(sp_code = species_id)


# ..... update site smry data .....
site_smry <- site_smry %>%
  select(collection_id, sp_id) %>% 
  mutate(location_id = collection_id) %>%
  
  # change sp_id to lower case
  mutate(sp_code = tolower(sp_id)) %>% 
  
  # remove sp_id column
  select(-sp_id) %>%
  
  # remove quotes around strings
  mutate(collection_id = str_remove_all(collection_id, "\""),
         sp_code = str_remove_all(sp_code, "\""),
         location_id = str_remove_all(location_id, "\""))


## ==================================================
##                   join data                   ----
## ==================================================

# ..... join rwi, metadata, and site summary .....
rwi_species <- rwi_long %>% 
  
  # join rwi to site_summary by collection id
  left_join(y = site_smry, by = 'collection_id') %>% 
  
  #join with species metadata
  left_join(y = species_metadata, by = "sp_code") #%>%
```


```{r, plot top spp}
## ==================================================
##                  plot 20 top spp              ----
## ==================================================
# create df with counts of collection ID
sp_count <- plyr::count(rwi_species$spp) %>% 
  rename(spp = x)

# plot top 20 collection ID counts
sp_count %>% 
  drop_na(spp) %>% 
  slice_max(order_by = freq, n = 20) %>% 
  ggplot() +
  geom_col(aes(x = fct_reorder(spp, freq), y = freq)) +
  labs(x = "Genus Species",
       y = "Number of Samples",
       title = "20 Most Sampled Species") +
  geom_text(aes(x = fct_reorder(spp, freq), y = freq,
                label = freq), hjust = 1.2, color = "white", size = 2.5) +
  coord_flip() +
  theme_minimal() 
```
### Subset PSME
```{r psme subset}
## ==================================================
##                 create psme subset            ----
## ==================================================
# subset most sampled species
psme_rwi <- rwi_species %>% 
  filter(spp == "Pseudotsuga menziesii")
```

```{r read range shp}
## ==================================================
##                 PSME range map                ----
## ==================================================

# define query for psme range
query <- "SELECT * FROM merged_ranges_dissolve WHERE sp_code='psme' "

# read in psme geometry data
psme_range <- st_read(here("~", "..", "..", "capstone", "climatree", "dataverse-archive",  "merged_ranges_dissolve.shp"), query = query) %>% 
  st_make_valid()

# plot psme range
tm_shape(psme_range) +
  tm_polygons()
```
## Climate Variables
### Historic aet and pwd
```{r}
## ==================================================
##              prep clim raster data           ----
## ==================================================

# ..... read in climate files .....             ----
load(here("~","..", "..", "capstone", "climatree", "dataverse-archive", "HistoricCWD_AETGrids_Annual.Rdat"))

# take mean of raster stack (combine years?)
cwd_historic <- mean(cwd_historic) 
aet_historic <- mean(aet_historic)

# calc historic pet ----
pet_historic <- aet_historic + cwd_historic

# plot data ----
tm_shape(pet_historic) +
  tm_raster()

```

### CMIP5 Climate Projections
```{r}

```

__Question:__ In the previous __3b. Species niche.R__ work, `cwd_historic` is the `mean(cwd_historic)`. Why are there multiple rasters for each climate variable if the mean was already taken? Or is `cwd_historic` downloaded as annual data, and we need to apply the `mean()` function independently?

```{r}
## ==================================================
##            site-specific clim data            ----
## ==================================================

# update site_id column
site_clim <- site_clim %>% 
  mutate("site_id" = as.character(site)) %>% 
  rename(location_id = site_id)

```


